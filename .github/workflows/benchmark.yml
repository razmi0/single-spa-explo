name: Benchmark

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    benchmark:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: |
                      esm-roots/vite/package-lock.json
                      esm-roots/rspack/package-lock.json
                      esm-roots/webpack/package-lock.json
                      esm-roots/shared/package-lock.json

            - name: Install hyperfine
              run: |
                  wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
                  sudo dpkg -i hyperfine_1.18.0_amd64.deb

            - name: Install Shared dependencies
              working-directory: esm-roots/shared
              run: npm ci || npm install

            - name: Build shared
              working-directory: esm-roots/shared
              run: npm run build

            - name: Install Vite dependencies
              working-directory: esm-roots/vite
              run: npm ci || npm install

            - name: Install Rspack dependencies
              working-directory: esm-roots/rspack
              run: npm ci || npm install

            - name: Install Webpack dependencies
              working-directory: esm-roots/webpack
              run: npm ci || npm install

            - name: Run benchmarks
              working-directory: bench
              run: node benchmark.mjs --runs 3 --warmup 1

            - name: Upload benchmark results
              uses: actions/upload-artifact@v4
              with:
                  name: benchmark-results
                  path: bench/results/benchmarks.json

            - name: Comment benchmark results on PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const results = JSON.parse(fs.readFileSync('bench/results/benchmarks.json', 'utf8'));

                      let comment = '## ðŸ“Š Benchmark Results\n\n';
                      comment += '| Bundler | Mode | Mean | Stddev | Min | Max |\n';
                      comment += '|---------|------|------|--------|-----|-----|\n';

                      const formatMs = (seconds) => `${(seconds * 1000).toFixed(0)} ms`;

                      for (const [key, data] of Object.entries(results)) {
                        const bundler = key.replace(/Dev|Build/, '');
                        const mode = key.includes('Dev') ? 'Dev Server' : 'Build';
                        comment += `| ${bundler} | ${mode} | ${formatMs(data.mean)} | ${formatMs(data.stddev)} | ${formatMs(data.min)} | ${formatMs(data.max)} |\n`;
                      }

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: comment
                      });
